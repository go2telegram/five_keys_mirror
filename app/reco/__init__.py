"""Recommendation helpers and context-specific copy."""

from __future__ import annotations

from typing import List

from app.products import PRODUCTS

# Контекстные подсказки, зависящие от ситуации
CTX = {
    # калькуляторы
    "msd": {
        "OMEGA3": "Поддерживает обмен липидов и чувствительность клеток к сигналам — легче держать вес.",
        "TEO_GREEN": "Кормит микробиом клетчаткой → лучшее усвоение, меньше тяга к сладкому.",
    },
    "bmi_deficit": {
        "TEO_GREEN": "Нормализует работу ЖКТ — помогает набирать «правильный» вес без дискомфорта.",
        "OMEGA3": "Строительный материал для мембран и нервной системы — поддержка аппетита и настроения.",
    },
    "bmi_norm": {
        "T8_BLEND": "Антиоксидантная защита и мягкая ежедневная энергия.",
        "VITEN": "Индуктор интерферона — держит иммунитет на уровне.",
    },
    "bmi_over": {
        "TEO_GREEN": "Баланс микробиоты → меньше воспаления, устойчивее контроль аппетита.",
        "T8_EXTRA": "Полипренолы поддерживают митохондрии — улучшают энергетику и выносливость.",
    },
    "bmi_obese": {
        "T8_EXTRA": "Улучшает энергетический обмен на клеточном уровне.",
        "TEO_GREEN": "Помогает выстроить регулярный стул и снизить тягу к быстрым углеводам.",
    },
    # квиз «энергия»
    "energy_norm": {
        "OMEGA3": "Поддерживает мозг, сосуды и противовоспалительный баланс.",
        "VITEN": "Быстрый щит в сезон простуд — меньше срывов по здоровью.",
    },
    "energy_light": {
        "T8_BLEND": "Ягоды + SibXP: антиоксиданты и мягкая поддержка энергии ежедневно.",
        "VITEN": "Поможет реже «вырубаться» из-за простуд и стрессов.",
        "TEO_GREEN": "Микробиом = фундамент устойчивой энергии.",
    },
    "energy_high": {
        "T8_EXTRA": "Восстановление мембран митохондрий → больше АТФ, меньше усталости.",
        "VITEN": "Иммунная поддержка, чтобы восстановление не срывало план.",
        "MOBIO": "Метабиотик для ЖКТ — помогает после антибиотиков/стрессов.",
    },
    # квиз «иммунитет»
    "immunity_good": {
        "OMEGA3": "Поддержка сердца и сосудов, снижение воспалений.",
        "D3": "Дефицит витамина D — частая причина снижения иммунитета.",
    },
    "immunity_mid": {
        "VITEN": "Природный индуктор интерферона, помогает быстрее отвечать на вирусы.",
        "T8_BLEND": "Антиоксидантная поддержка и профилактика простуд.",
    },
    "immunity_low": {
        "VITEN": "Щит против вирусов — усиливает иммунный ответ.",
        "T8_BLEND": "Снижает воспаление и поддерживает силы в период болезней.",
        "D3": "Помогает иммунитету работать правильно, особенно осенью-зимой.",
    },
    # квиз «ЖКТ / микробиом»
    "gut_ok": {
        "TEO_GREEN": "Кормит микробиом растворимой/нерастворимой клетчаткой — база стабильного ЖКТ.",
        "OMEGA3": "Снижает воспалительные маркеры, поддерживает слизистые и моторику.",
    },
    "gut_mild": {
        "TEO_GREEN": "Регуляризует стул и уменьшает вздутие за счёт пребиотиков.",
        "MOBIO": "Метабиотик: доставляет полезные метаболиты сразу в толстую кишку.",
    },
    "gut_high": {
        "MOBIO": "Быстро восстанавливает микробиоту после антибиотиков/стрессов.",
        "TEO_GREEN": "Ежедневная клетчатка → меньше тяги к сладкому и ровнее аппетит.",
        "OMEGA3": "Противовоспалительная поддержка слизистых ЖКТ.",
    },
    # квиз «сон»
    "sleep_ok": {
        "OMEGA3": "Поддерживает работу мозга и нервной системы, улучшает глубину сна.",
        "D3": "Регулирует циркадные ритмы, влияет на качество сна.",
    },
    "sleep_mild": {
        "MAG_B6": "Уменьшает стресс и мышечное напряжение, помогает расслабиться.",
        "OMEGA3": "Снижает воспаление и поддерживает стабильное настроение.",
    },
    "sleep_high": {
        "MAG_B6": "Поддержка нервной системы и расслабление.",
        "OMEGA3": "Помогает при частых пробуждениях и тревожности.",
        "D3": "Дефицит D связан с хроническими нарушениями сна.",
    },
    # квиз «стресс»
    "stress_ok": {
        "OMEGA3": "Поддерживает нервную систему и стабильное настроение.",
        "T8_BLEND": "Антиоксидантная поддержка и мягкая ежедневная энергия.",
    },
    "stress_mid": {
        "MAG_B6": "Снижает нервное напряжение и улучшает качество сна.",
        "OMEGA3": "Противовоспалительная поддержка нервной системы.",
    },
    "stress_high": {
        "MAG_B6": "Помогает снять мышечные зажимы и расслабиться перед сном.",
        "OMEGA3": "Поддерживает мозг, снижает тревожность.",
        "T8_BLEND": "Борется с оксидативным стрессом, даёт мягкий тонус.",
    },
    "deficit_low": {
        "OMEGA3": "Поддерживает баланс омега-3 и эластичность кожи.",
        "MAG_B6": "Сохраняет спокойный сон и устойчивость нервной системы.",
        "D3": "Помогает стабилизировать иммунитет и настроение круглый год.",
    },
    "deficit_mid": {
        "OMEGA3": "Добавь регулярную поддержку мембран мозга и сердца.",
        "MAG_B6": "Вечерний магний снижает мышечное напряжение и стресс.",
        "D3": "Курс витамина D выровняет гормональный фон и тонус.",
    },
    "deficit_high": {
        "OMEGA3": "Высокая концентрация EPA/DHA закрывает выраженный дефицит.",
        "MAG_B6": "Курс магния помогает убрать судороги и напряжение.",
        "D3": "Обсуди оптимальную дозировку D3 для восстановления уровня.",
    },
    "skin_joint_low": {
        "ERA_MIT_UP": "Коллаген и уролитин поддерживают упругость кожи и связок.",
        "OMEGA3": "Снижает воспаления и помогает суставам двигаться мягко.",
        "T8_BLEND": "Антиоксиданты берегут кожу от стресса и дают энергию.",
    },
    "skin_joint_mid": {
        "ERA_MIT_UP": "Курсовой коллаген восстанавливает связки и эластичность кожи.",
        "OMEGA3": "Регулярный приём улучшает смазку суставов и состояние кожи.",
        "T8_BLEND": "СибXP-комплекс защищает клетки от воспаления и окисления.",
    },
    "skin_joint_high": {
        "ERA_MIT_UP": "Комплекс с уролитином ускоряет регенерацию кожи и соединительной ткани.",
        "OMEGA3": "Высокая доза омега-3 снижает жёсткость суставов и поддерживает дерму.",
        "T8_BLEND": "Сильные антиоксиданты уменьшают воспаление и улучшают тонус кожи.",
    },
}


def product_lines(codes: List[str], context: str) -> List[str]:
    """Return formatted recommendation lines for the selected products."""

    out: list[str] = []
    for code in codes:
        p = PRODUCTS.get(code, {})
        title = p.get("title", code)
        generic = p.get("bullets", [""])[0]
        help_text = CTX.get(context, {}).get(code)
        if help_text:
            out.append(f"— <b>{title}</b>: {generic}\n  Как поможет сейчас: <i>{help_text}</i>")
        else:
            out.append(f"— <b>{title}</b>: {generic}")
    return out


__all__ = ["CTX", "product_lines"]
