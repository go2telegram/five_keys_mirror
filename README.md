# five_keys_bot

–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç Telegram –¥–ª—è MITO-—Å–æ–æ–±—â–µ—Å—Ç–≤–∞. –ë–æ—Ç —Å–æ–±–∏—Ä–∞–µ—Ç –∑–∞—è–≤–∫–∏, –≤—ã–¥–∞—ë—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∞–º–∏.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+
- venv –∏–ª–∏ –ª—é–±–∞—è –¥—Ä—É–≥–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
- Docker (–¥–ª—è –ø—Ä–æ–¥–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (dev)

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
pip install -r requirements-dev.txt  # –≤–∫–ª—é—á–∞–µ—Ç aiosqlite –¥–ª—è SQLite
cp .env.example .env
```

> üí° –ù–∞ Windows –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º –∫–æ–Ω—Å–æ–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `chcp 65001` –∏
> `setx PYTHONIOENCODING utf-8`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π.

–í `.env` —É–∫–∞–∂–∏—Ç–µ `BOT_TOKEN`, `ADMIN_ID` –∏ –¥—Ä—É–≥–∏–µ –∫–ª—é—á–∏. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite (`sqlite+aiosqlite:///./var/bot.db`),
–ø–æ—ç—Ç–æ–º—É —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥—Ä–∞–π–≤–µ—Ä `aiosqlite` (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `pip install -r requirements-dev.txt`).
–í–∫–ª—é—á–µ–Ω–∏–µ Tribute webhook-–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–¥–∞–π—Ç–µ `RUN_TRIBUTE_WEBHOOK=true`, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø—Ä–∏—ë–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç Tribute.

## –û—Ñ–ª–∞–π–Ω —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (Windows, Python 3.11)

1) –í GitHub Actions –∑–∞–ø—É—Å—Ç–∏—Ç–µ workflow **Build offline wheels (win_amd64, py311)** (*Actions ‚Üí Build offline wheels ‚Üí Run workflow*), —Å–∫–∞—á–∞–π—Ç–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç `wheels-win_amd64-cp311.zip` –∏ —Ä–∞—Å–ø–∞–∫—É–π—Ç–µ –µ–≥–æ –≤ –∫–∞—Ç–∞–ª–æ–≥ `./wheels`.
2) –°–æ–∑–¥–∞–π—Ç–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
   ```powershell
   python -m venv .venv
   .\.venv\Scripts\Activate.ps1
   ```
3) –í—ã–ø–æ–ª–Ω–∏—Ç–µ –æ—Ñ–ª–∞–π–Ω-—É—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–ª—ë—Å:
   ```powershell
   powershell -ExecutionPolicy Bypass -File .\scripts\offline_install.ps1 -WheelsDir .\wheels
   ```
4) –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ `.env` —Å –∫–ª—é—á–∞–º–∏ (`BOT_TOKEN`, `DB_URL=sqlite+aiosqlite:///./var/bot.db`, `TIMEZONE`, `ADMIN_ID`).
5) –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ:
   ```powershell
   mkdir var
   alembic upgrade head
   python scripts\db_check.py  # ok –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true
   ```
6) –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:
   ```powershell
   python -m app.main
   ```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü—Ä–∏–º–µ—Ä `.env`:

```
BOT_TOKEN=123:ABC
DB_URL=sqlite+aiosqlite:///./var/bot.db
TIMEZONE=Europe/Moscow
```

–ö–æ–º–∞–Ω–¥—ã:

```bash
make upgrade                  # –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (—Å–æ–∑–¥–∞—ë—Ç var/ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
make migrate msg="add table"  # —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
make db-check                 # –ø—Ä–µ–¥–∑–∞–ø—É—Å–∫–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î
make dev                      # –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (python -m app.main)
```

## –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ

```bash
make dev
```

–ö–æ–º–∞–Ω–¥–∞ –≤—ã–∑–æ–≤–µ—Ç `init_db()`, –≤—ã–ø–æ–ª–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç polling.
Tribute webhook –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ `.env` —É–∫–∞–∑–∞–Ω `RUN_TRIBUTE_WEBHOOK=true`.

## –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (`/start` ‚Üí –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏):

- ‚ö° –¢–µ—Å—Ç —ç–Ω–µ—Ä–≥–∏–∏ ‚Äî `quiz:energy`
- üìê –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã ‚Äî `calc:menu`
- üíä –ü–æ–¥–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Äî `pick:menu`
- üéÅ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Äî `reg:open`
- üíé –ü—Ä–µ–º–∏—É–º ‚Äî `premium:menu`
- üë§ –ü—Ä–æ—Ñ–∏–ª—å ‚Äî `profile:open`
- üîó –†–µ—Ñ. —Å—Å—ã–ª–∫–∞ ‚Äî `ref:menu`
- üé´ –ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî `sub:menu`
- üß≠ –ù–∞–≤–∏–≥–∞—Ç–æ—Ä ‚Äî `nav:root`
- üßæ PDF –æ—Ç—á—ë—Ç ‚Äî `report:last`
- üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Äî `notify:help`

## Admin CRUD

–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–∑–æ–π (–Ω—É–∂–µ–Ω `ADMIN_ID` –∏–ª–∏ `ADMIN_USER_IDS` –≤ `.env`):

- `/admin_help` ‚Äî —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –æ–ø–µ—Ä–∞—Ü–∏—è–º.
- `/users [page] [query]` ‚Äî —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–∞–≥–∏–Ω–∞—Ü–∏—è, –ø–æ–∏—Å–∫ –ø–æ username/id).
- `/user <id>` ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–¥–ø–∏—Å–∫–∏.
- `/sub_get <id>` / `/sub_set <id> <plan> <days>` / `/sub_del <id>` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏.
- `/refs <id> [period]` ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–ø–µ—Ä–∏–æ–¥—ã `7d`, `30d`, `all`).
- `/ref_convert <invited_id> [bonus_days]` ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å –±–æ–Ω—É—Å–Ω—ã–µ –¥–Ω–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä—É.

## –¢–µ—Å—Ç—ã

```bash
pytest
```

## Docker (prod)

1. –°–æ–∑–¥–∞–π—Ç–µ `.env` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ Postgres (`DB_URL=postgresql+asyncpg://...`).
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ:
   ```bash
   docker compose up --build
   ```

Docker-compose –ø–æ–¥–Ω–∏–º–µ—Ç Postgres, –≤—ã–ø–æ–ª–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç –±–æ—Ç–∞ –æ—Ç non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

- `app/db` ‚Äî –º–æ–¥–µ–ª–∏ –∏ —Å–µ—Å—Å–∏–∏ SQLAlchemy.
- `app/repo` ‚Äî —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è async-–¥–æ—Å—Ç—É–ø–∞.
- `alembic` ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏.
- `app/handlers` ‚Äî aiogram-—Ä–æ—É—Ç–µ—Ä—ã.
- `tests/` ‚Äî —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.

## –ü–æ–ª–µ–∑–Ω–æ–µ

- `python -m app.main` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –≤—Ö–æ–¥.
- `alembic current` ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å—Ö–µ–º—ã.
- `make dev` / `make migrate msg=...` ‚Äî —Å–º. Makefile.
