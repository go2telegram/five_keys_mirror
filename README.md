# five_keys_bot

–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç Telegram –¥–ª—è MITO-—Å–æ–æ–±—â–µ—Å—Ç–≤–∞. –ë–æ—Ç —Å–æ–±–∏—Ä–∞–µ—Ç –∑–∞—è–≤–∫–∏, –≤—ã–¥–∞—ë—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∞–º–∏.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+
- venv –∏–ª–∏ –ª—é–±–∞—è –¥—Ä—É–≥–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
- Docker (–¥–ª—è –ø—Ä–æ–¥–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (dev)

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
pip install -r requirements-dev.txt  # –≤–∫–ª—é—á–∞–µ—Ç aiosqlite –¥–ª—è SQLite
cp .env.example .env
```

> üí° –ù–∞ Windows –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º –∫–æ–Ω—Å–æ–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `chcp 65001` –∏
> `setx PYTHONIOENCODING utf-8`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π.

–í `.env` —É–∫–∞–∂–∏—Ç–µ `BOT_TOKEN`, `ADMIN_ID` –∏ –¥—Ä—É–≥–∏–µ –∫–ª—é—á–∏. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite (`sqlite+aiosqlite:///./var/bot.db`),
–ø–æ—ç—Ç–æ–º—É —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥—Ä–∞–π–≤–µ—Ä `aiosqlite` (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `pip install -r requirements-dev.txt`).
–í–∫–ª—é—á–µ–Ω–∏–µ Tribute webhook-–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–¥–∞–π—Ç–µ `RUN_TRIBUTE_WEBHOOK=true`, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø—Ä–∏—ë–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç Tribute.

## –û—Ñ–ª–∞–π–Ω —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (Windows, Python 3.11)

1) –í GitHub Actions –∑–∞–ø—É—Å—Ç–∏—Ç–µ workflow **Build offline wheels (win_amd64, py311)** (*Actions ‚Üí Build offline wheels ‚Üí Run workflow*), —Å–∫–∞—á–∞–π—Ç–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç `wheels-win_amd64-cp311.zip` –∏ —Ä–∞—Å–ø–∞–∫—É–π—Ç–µ –µ–≥–æ –≤ –∫–∞—Ç–∞–ª–æ–≥ `./wheels` –∏–ª–∏ –ª—é–±—É—é –¥—Ä—É–≥—É—é –ø–∞–ø–∫—É (–µ—ë –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —á–µ—Ä–µ–∑ `-WheelsDir` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `WHEELS_DIR`).
2) –°–æ–∑–¥–∞–π—Ç–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
   ```powershell
   python -m venv .venv
   .\.venv\Scripts\Activate.ps1
   ```
3) –í—ã–ø–æ–ª–Ω–∏—Ç–µ –æ—Ñ–ª–∞–π–Ω-—É—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–ª—ë—Å (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –≤–Ω–µ—à–Ω–µ–º—É –∫–∞—Ç–∞–ª–æ–≥—É):
   ```powershell
   powershell -ExecutionPolicy Bypass -File .\scripts\offline_install.ps1 -WheelsDir .\wheels
   ```
4) –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ `.env` —Å –∫–ª—é—á–∞–º–∏ (`BOT_TOKEN`, `DB_URL=sqlite+aiosqlite:///./var/bot.db`, `TIMEZONE`, `ADMIN_ID`).
5) –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ:
   ```powershell
   mkdir var
   alembic upgrade head
   python scripts\db_check.py  # ok –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true
   ```
6) –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:
   ```powershell
   python -m app.main
   ```

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –∫–æ–ø–∏–∏ (Windows)

–°–∫—Ä–∏–ø—Ç `scripts/update_local.cmd` –∑–∞–ø—É—Å–∫–∞–µ—Ç PowerShell-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º –∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö. –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `./scripts/logs/update_*.log`.

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å PowerShell-—Å–∫—Ä–∏–ø—Ç –Ω–∞–ø—Ä—è–º—É—é:

```powershell
powershell -ExecutionPolicy Bypass -File .\scripts\update_local.ps1 -Branch main -WheelsDir "C:\\dev\\_wheels"
```

–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

- `-Branch` ‚Äî –≤–µ—Ç–∫–∞, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –ø–æ–¥—Ç—è–Ω—É—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∞—è).
- `-WheelsDir` ‚Äî –ø—É—Ç—å –∫ –∫–∞—Ç–∞–ª–æ–≥—É —Å —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ–ª—ë—Å–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `./wheels`, –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —á–µ—Ä–µ–∑ `WHEELS_DIR`).
- `-NoRunBot` ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ —Å—Ç–∞—Ä—Ç–∞ `python -m app.main` (—É–¥–æ–±–Ω–æ –¥–ª—è smoke-–ø—Ä–æ–≥–æ–Ω–æ–≤).

–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—ë—Ç/–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç `.venv`, –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–µ—Ç–∫—É (–Ω–µ —Ç—Ä–æ–≥–∞—è `wheels/`, `var/`, `logs/`, `dist/`), –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ—Ñ–ª–∞–π–Ω-—É—Å—Ç–∞–Ω–æ–≤–∫—É, –ø—Ä–æ–≥–æ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î, —Å–Ω–∏–º–∞–µ—Ç –≤–µ–±—Ö—É–∫ –∏ (–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω `-NoRunBot`) –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞. –í –∫–æ–Ω—Ü–µ –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –ø—É—Ç—å –∫ –ª–æ–≥—É `Log: .\scripts\logs\update_YYYYMMDD_HHMMSS.log`.

## –¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏ –∞–ø–¥–µ–π—Ç–µ—Ä–∞

- `Offline wheels directory not found` ‚Äî —Ä–∞—Å–ø–∞–∫—É–π—Ç–µ `wheels-win_amd64-cp311.zip` –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ `-WheelsDir`.
- `No wheel files detected in ...` ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–µ–∂–∞—Ç `.whl` –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞.
- `Missing package: <–∏–º—è>` ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ `.whl` –Ω–µ—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ; –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—É—Å–∫.
- `db_check.py` —Å–æ–æ–±—â–∞–µ—Ç `ok: false` ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å; –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—É—Å–∫ –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `alembic upgrade head` –≤—Ä—É—á–Ω—É—é –∏ –∏–∑—É—á–∏—Ç–µ –ª–æ–≥ –≤ `./scripts/logs`.
- `ParserError at offline_install.ps1` ‚Äî —Ñ–∞–π–ª –±—ã–ª –∏—Å–ø–æ—Ä—á–µ–Ω (–Ω–µ-ASCII –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞). –ê–ø–¥–µ–π—Ç–µ—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ `update_local.ps1`.

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü—Ä–∏–º–µ—Ä `.env`:

```
BOT_TOKEN=123:ABC
DB_URL=sqlite+aiosqlite:///./var/bot.db
TIMEZONE=Europe/Moscow
VELAVIE_URL=https://velavie.example/landing
RUN_TRIBUTE_WEBHOOK=false
TRIBUTE_API_KEY=change-me
TRIBUTE_LINK_BASIC=https://tribute.to/pay/basic
TRIBUTE_LINK_PRO=https://tribute.to/pay/pro
SUB_BASIC_PRICE=299 ‚ÇΩ/–º–µ—Å
SUB_PRO_PRICE=599 ‚ÇΩ/–º–µ—Å
```

–ö–æ–º–∞–Ω–¥—ã:

```bash
make upgrade                  # –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (—Å–æ–∑–¥–∞—ë—Ç var/ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
make migrate msg="add table"  # —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
make db-check                 # –ø—Ä–µ–¥–∑–∞–ø—É—Å–∫–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î
make dev                      # –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (python -m app.main)
make fmt                      # black + ruff --fix
make lint                     # ruff check
```

## –ü–æ–¥–ø–∏—Å–∫–∞ MITO —á–µ—Ä–µ–∑ Tribute

1. –í Tribute –∑–∞–¥–∞–π—Ç–µ —Å–µ–∫—Ä–µ—Ç –¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤ –∏ –ø—Ä–æ–ø–∏—à–∏—Ç–µ URL `https://<–¥–æ–º–µ–Ω>${TRIBUTE_WEBHOOK_PATH}` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `/tribute/webhook`).
2. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á –≤ `.env` (`TRIBUTE_API_KEY`) –∏ –≤–∫–ª—é—á–∏—Ç–µ –ø—Ä–∏—ë–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π `RUN_TRIBUTE_WEBHOOK=true` (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –±–æ—Ç –ø–æ–¥–Ω–∏–º–µ—Ç aiohttp-—Å–µ—Ä–≤–µ—Ä –Ω–∞ `TRIBUTE_PORT`).
3. –£–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É (`TRIBUTE_LINK_BASIC`, `TRIBUTE_LINK_PRO`) –∏ –ø–æ–¥–ø–∏—Å–∏ —Å —Ü–µ–Ω–∞–º–∏ (`SUB_BASIC_PRICE`, `SUB_PRO_PRICE`) ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–æ–¥–ø–∏—Å–∫–∞¬ª.
4. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã Tribute –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ `new_subscription`: –±–æ—Ç –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ç–∞—Ä–∏—Ñ, —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Å–æ–±—ã—Ç–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∫–Ω–æ–ø–∫—É ¬´–û—Ç–∫—Ä—ã—Ç—å Premium¬ª. –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ (`cancelled_subscription`) –¥–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –¥–∞—Ç—É `expires_at`, –∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏–ª–µ—Ç–∏—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏.
5. –î–ª—è smoke-–ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å `pytest tests/test_tribute_stub.py` ‚Äî —Ç–∞–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è HMAC –∏ –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–±–æ—Ä payload.

–ï—Å–ª–∏ –≤–µ–±—Ö—É–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—ë —Ä–∞–≤–Ω–æ –º–æ–∂–µ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´üîÅ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å¬ª ‚Äî –±–æ—Ç –ø–æ–¥–Ω–∏–º–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –∏ –ø–æ–∫–∞–∂–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏.

## –õ–∏–Ω—Ç–∏–Ω–≥ –∏ pre-commit

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ö—É–∫–æ–≤

```bash
make hooks
```

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è Windows:

```powershell
powershell -ExecutionPolicy Bypass -File .\scripts\setup_dev.ps1
```

–°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç `pre-commit`, –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ö—É–∫–∏ –∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≥–æ–Ω–∏—Ç –∏—Ö –ø–æ –≤—Å–µ–º—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ö—É–∫–∏ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞, –¥–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä `-InstallOnly`.

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫

```bash
ruff check . --fix
black .
pre-commit run --all-files
```

–ö–æ–º–±–∏–Ω–∞—Ü–∏—è `ruff --fix` –∏ `black` –ø–æ–≤—Ç–æ—Ä—è–µ—Ç CI. –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `black --check .`.

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –∑–∞–º–µ—á–∞–Ω–∏—è—Ö

- `end-of-file-fixer` ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–≤–µ—Ä—à–∞—é—â—É—é –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É (—Ñ–∞–π–ª—ã `*.json`/`*.yml` –¥–æ–ª–∂–Ω—ã –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –ø–µ—Ä–µ–≤–æ–¥–æ–º —Å—Ç—Ä–æ–∫–∏).
- `mixed-line-ending` ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `*.ps1` –∏—Å–ø–æ–ª—å–∑—É—é—Ç CRLF, –∞ YAML/JSON ‚Äî LF (–ø—Ä–∞–≤–∏–ª–∞ –æ–ø–∏—Å–∞–Ω—ã –≤ `.editorconfig`).
- `check-yaml`/`check-json` ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–∞–∂–¥—ã–π –∫–ª—é—á —Å–æ–¥–µ—Ä–∂–∏—Ç `:` –∏ —Å–æ–±–ª—é–¥—ë–Ω –æ—Ç—Å—Ç—É–ø –≤ –¥–≤–∞ –ø—Ä–æ–±–µ–ª–∞ –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤.
- –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π —Ö—É–∫–æ–≤ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ `pre-commit autoupdate` –∏ –∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `.pre-commit-config.yaml`.

CI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∞–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫ PR: –æ—Ç–¥–µ–ª—å–Ω–∞—è job –ø—Ä–æ–≥–æ–Ω—è–µ—Ç `ruff --fix`, `black` –∏ `pre-commit run --all-files`, –∞ –∑–∞—Ç–µ–º –∫–æ–º–º–∏—Ç–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –µ—Å–ª–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ñ–∏–∫—Å–∞ –æ—Å—Ç–∞—é—Ç—Å—è –æ—à–∏–±–∫–∏, –∏—Ö –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é.

## –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ

```bash
make dev
```

–ö–æ–º–∞–Ω–¥–∞ –≤—ã–∑–æ–≤–µ—Ç `init_db()`, –≤—ã–ø–æ–ª–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç polling.
Tribute webhook –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ `.env` —É–∫–∞–∑–∞–Ω `RUN_TRIBUTE_WEBHOOK=true`.

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/ping`, –¥–æ–±–∞–≤–∏–≤ `DEBUG_COMMANDS=true` –≤ `.env`. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —ç—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Å–∫—Ä—ã—Ç–∞.

## –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `/start`

–ú–∞—Ä—à—Ä—É—Ç `/start` —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –¥–≤—É—Ö —Å–ª–æ—ë–≤:

- ¬´—Ç–æ–Ω–∫–∏–π¬ª —Ö–µ–Ω–¥–ª–µ—Ä —Å—Ä–∞–∑—É –æ—Ç–≤–µ—á–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π (`kb_main()`), –ø–æ—ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–∏–¥–∏—Ç –º–µ–Ω—é –¥–∞–∂–µ –ø—Ä–∏
  –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –±–∞–∑–æ–π;
- —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç ¬´—Ç–æ–ª—Å—Ç—É—é¬ª –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤–∫–ª—é—á–∏—Ç—å
  —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) –∏ –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ `logging.exception("start_full failed")`, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –æ—Ç–≤–µ—Ç.

–í —Ç–µ—Å—Ç–∞—Ö (`tests/test_updates_smoke.py`) –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ Dispatcher –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ `message` –∏ `callback_query`, –∞ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π
—Ö–µ–Ω–¥–ª–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–∞–∂–µ –ø—Ä–∏ —Å–±–æ–µ –ë–î. –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–æ–º–æ–π –∏–∑ –ª—é–±–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `kb_back_home()`, –∞ –∫–æ–º–∞–Ω–¥–∞
`/ping` –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `DEBUG_COMMANDS=true`.

## –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (`/start` ‚Üí –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏):

- ‚ö° –¢–µ—Å—Ç —ç–Ω–µ—Ä–≥–∏–∏ ‚Äî `quiz:energy`
- üìê –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã ‚Äî `calc:menu`
- üíä –ü–æ–¥–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Äî `pick:menu`
- üéÅ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Äî `reg:open`
- üíé –ü—Ä–µ–º–∏—É–º ‚Äî `premium:menu`
- üë§ –ü—Ä–æ—Ñ–∏–ª—å ‚Äî `profile:open`
- üîó –†–µ—Ñ. —Å—Å—ã–ª–∫–∞ ‚Äî `ref:menu`
- üé´ –ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî `sub:menu`
- üß≠ –ù–∞–≤–∏–≥–∞—Ç–æ—Ä ‚Äî `nav:root`
- üßæ PDF –æ—Ç—á—ë—Ç ‚Äî `report:last`
- üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Äî `notify:help`

## –ë—ã—Å—Ç—Ä—ã–π smoke-—á–µ–∫ `/start`

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ `make dev` (–∏–ª–∏ `python -m app.main`).
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` ‚Üí —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ.
3. –ù–∞–∂–º–∏—Ç–µ –ø–∞—Ä—É –∫–Ω–æ–ø–æ–∫: –µ—Å–ª–∏ —Ä–∞–∑–¥–µ–ª –Ω–µ –≥–æ—Ç–æ–≤, –±–æ—Ç –ø–æ–∫–∞–∂–µ—Ç –∑–∞–≥–ª—É—à–∫—É —Å –∫–Ω–æ–ø–∫–æ–π ¬´–î–æ–º–æ–π¬ª.
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `DEBUG_COMMANDS=true` –≤ `.env` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ ‚Üí –∫–æ–º–∞–Ω–¥–∞ `/ping` –¥–æ–ª–∂–Ω–∞ –æ—Ç–≤–µ—á–∞—Ç—å `pong ‚úÖ`.
5. –í–µ—Ä–Ω–∏—Ç–µ `DEBUG_COMMANDS=false` ‚Äî `/ping` —Å–Ω–æ–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

## –ö–≤–∏–∑—ã –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ª—é–±–æ–≥–æ –∫–≤–∏–∑–∞ –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥–±–æ—Ä–∫—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞: —É –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ,
–∫–ª—é—á–µ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ ¬´–∫–∞–∫ –ø–æ–º–æ–∂–µ—Ç —Å–µ–π—á–∞—Å¬ª —Å —É—á—ë—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—ç–Ω–µ—Ä–≥–∏—è, —Å–æ–Ω, —Å—Ç—Ä–µ—Å—Å, –ñ–ö–¢, –∏–º–º—É–Ω–∏—Ç–µ—Ç). –ü–µ—Ä–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
–æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≥–∞–ª–µ—Ä–µ–µ–π, –∞ –ø–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–µ–π—Å—Ç–≤–∏–π:

- ¬´–ö—É–ø–∏—Ç—å ‚Ä¶¬ª ‚Äî –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç;
- ¬´PDF-–ø–ª–∞–Ω¬ª ‚Äî –≤—ã–∑–æ–≤ `report:last` —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –æ—Ç—á—ë—Ç–æ–º;
- ¬´–ó–∞–∫–∞–∑–∞—Ç—å —Å–æ —Å–∫–∏–¥–∫–æ–π¬ª ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Velavie-—Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ `VELAVIE_URL`;
- ¬´–î–æ–º–æ–π¬ª ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.

–ï—Å–ª–∏ –º–µ–¥–∏–∞–∫–∞—Ç–∞–ª–æ–≥ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –±–æ—Ç –≤—ã–≤–æ–¥–∏—Ç –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –¥–æ–º–æ–π —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É.

## –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã

–í —Ä–∞–∑–¥–µ–ª–∞—Ö ¬´MSD –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–µ—Å¬ª –∏ ¬´–ò–ú–¢¬ª –±–æ—Ç –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∞ –∑–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:

- –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º;
- —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ ¬´–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —É–∂–µ —Å–µ–≥–æ–¥–Ω—è¬ª;
- –∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏ ¬´–ö—É–ø–∏—Ç—å¬ª, ¬´PDF-–ø–ª–∞–Ω¬ª, ¬´–ó–∞–∫–∞–∑–∞—Ç—å —Å–æ —Å–∫–∏–¥–∫–æ–π¬ª, ¬´–ù–∞–∑–∞–¥¬ª –∏ ¬´–î–æ–º–æ–π¬ª.

–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞—Å—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ ‚Äî –µ–≥–æ –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –≤ PDF —á–µ—Ä–µ–∑ –ø—É–Ω–∫—Ç ¬´üßæ PDF –æ—Ç—á—ë—Ç¬ª –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.

## Admin CRUD

–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–∑–æ–π (–Ω—É–∂–µ–Ω `ADMIN_ID` –∏–ª–∏ `ADMIN_USER_IDS` –≤ `.env`):

- `/admin_help` ‚Äî —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –æ–ø–µ—Ä–∞—Ü–∏—è–º.
- `/users [page] [query]` ‚Äî —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–∞–≥–∏–Ω–∞—Ü–∏—è, –ø–æ–∏—Å–∫ –ø–æ username/id).
- `/user <id>` ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–¥–ø–∏—Å–∫–∏.
- `/sub_get <id>` / `/sub_set <id> <plan> <days>` / `/sub_del <id>` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏.
- `/refs <id> [period]` ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–ø–µ—Ä–∏–æ–¥—ã `7d`, `30d`, `all`).
- `/ref_convert <invited_id> [bonus_days]` ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å –±–æ–Ω—É—Å–Ω—ã–µ –¥–Ω–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä—É.

## –¢–µ—Å—Ç—ã

```bash
pytest
```

## Docker (prod)

1. –°–æ–∑–¥–∞–π—Ç–µ `.env` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ Postgres (`DB_URL=postgresql+asyncpg://...`).
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ:
   ```bash
   docker compose up --build
   ```

Docker-compose –ø–æ–¥–Ω–∏–º–µ—Ç Postgres, –≤—ã–ø–æ–ª–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç –±–æ—Ç–∞ –æ—Ç non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

- `app/db` ‚Äî –º–æ–¥–µ–ª–∏ –∏ —Å–µ—Å—Å–∏–∏ SQLAlchemy.
- `app/repo` ‚Äî —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è async-–¥–æ—Å—Ç—É–ø–∞.
- `alembic` ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏.
- `app/handlers` ‚Äî aiogram-—Ä–æ—É—Ç–µ—Ä—ã.
- `tests/` ‚Äî —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.

## –ü–æ–ª–µ–∑–Ω–æ–µ

- `python -m app.main` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –≤—Ö–æ–¥.
- `alembic current` ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å—Ö–µ–º—ã.
- `make dev` / `make migrate msg=...` ‚Äî —Å–º. Makefile.
