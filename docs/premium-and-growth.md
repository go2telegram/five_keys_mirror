# Премиум и рост: операционное руководство

## Оплата и биллинг

- **Платёжные методы:** поддерживаем карты Visa/Mastercard (РФ и СНГ), ЮKassa, а также промокоды Tribute.
- **Провайдер:** основной биллинг идёт через Tribute. API-ключ хранится в `TRIBUTE_API_KEY`, вебхук — `TRIBUTE_WEBHOOK_PATH`.
- **Фрод-чек:** Tribute отдаёт поле `fraud_score`; всё, что >70, уходит в ручную проверку.
- **Повторные списания:** ежемесячно за 3 дня до списания шлём пуш `/premium:renewal`. При ошибке пытаемся ещё 2 раза с интервалом 12 часов.
- **Инвойсы:** храним PDF в `build/invoices/<YYYY>/<MM>/<invoice_id>.pdf`, ссылка уходит клиенту в чате.

## Статусы подписки

| Статус | Что означает | Триггер |
| --- | --- | --- |
| `active` | оплачено и доступно | успешный вебхук Tribute |
| `grace` | 1–3 дня после неудачного автосписания | webhook `payment_failed` |
| `paused` | клиент заморозил | кнопка `/premium:pause` |
| `cancelled` | подписка завершена | webhook `subscription_cancelled` или `/premium:cancel` |

- Переход `grace → active` происходит автоматически при следующем успешном платеже.
- После `cancelled` пользователь теряет доступ сразу, данные храним 30 дней для ретаргета.

## Возвраты

1. Проверяем в CRM последний платёж и статус.
2. Если чек не закрыт — делаем возврат через Tribute Dashboard (доступ у финансовой).
3. В базе создаём событие `refund_issued` (таблица `events`).
4. Пользователю пишем шаблон: «Возврат оформлен, деньги будут в течение 3–5 рабочих дней».
5. Профиль переводим в статус `paused`, чтобы не спамить пушами.

## Отладка и поддержка

- **Журналы:** технический лог — `logs/bot.log`, ошибки — `logs/errors.log`, веб-сервер — `logs/service.log`.
- **Метрики:** `/metrics` отдаёт Prometheus-метрики, включая `five_keys_bot_recommend_requests_total`.
- **Тестовая среда:** ставим `.env.test` с `RUN_TRIBUTE_WEBHOOK=false`, запускаем `poetry run pytest`.
- **Сценарии:** для ручного QA есть команды `/start`, `/premium:menu`, `/tests` и `/recommend`.

## FAQ для команды

- **Не пришёл вебхук:** проверяем очередь в Tribute и наш сервис-порт (`HEALTH_PORT`). С 2024-11 fallback на порт `0`, так что коллизии не страшны.
- **Пользователь жалуется на рассылку:** команда `/erase_me` удаляет профиль, события и подписку.
- **Подписка не продлилась:** смотрим `events` → `payment_failed`, затем `retry_<n>`. Если три неудачи — пользователь получает ссылку на оплату вручную.
- **Как быстро обновляются планы:** cron `cleanup_stale_results` чистит старые результаты, а новые сохраняются сразу после теста/калькулятора.

## Данные и интеграции

- **Основные таблицы:**
  - `users` — учётки Telegram.
  - `subscriptions` — активные планы и сроки.
  - `profiles` — телефон и email в зашифрованном виде (Fernet, ключ `PII_KEY`).
  - `quiz_results` / `calculator_results` — история тестов и калькуляторов (очищаем после 180 дней).
- **Интеграции:**
  - Tribute Webhook → `app/handlers/tribute_webhook.py`.
  - Google Sheets экспорт → `tools/export_crm.py` (режим `csv` либо `google` по конфигу).
  - Prometheus scrape → `/metrics` внутри aiohttp сервиса.

> Документ поддерживает команда Premium & Growth. Обновлять при каждом релизе, где меняются тарифы, интеграции или политика хранения данных.
