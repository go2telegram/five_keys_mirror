# Канареечные релизы five_keys_bot

Канареечный релиз позволяет мягко раскатывать новую версию бота на небольшой
части трафика, сравнивая метрики новой сборки с текущей продакшен-версией.
Этот документ описывает необходимую инфраструктуру, процедуры запуска и правила
промоушена или отката.

## Инфраструктура и предпосылки

1. **Два deployment'а** в Kubernetes (или другой оркестрации):
   - `five-keys-bot` — продакшен.
   - `five-keys-bot-canary` — канарейка c переменной окружения `CANARY=1`.
2. **Балансировщик трафика**. Файл [`deploy/nginx.conf`](../deploy/nginx.conf)
   реализует распределение 90/10 между продом и канарейкой, отдельный URL для
   ручных вебхуков и раздельные endpoints для метрик.
3. **Мониторинг**. Экспонируйте `/metrics/stable` и `/metrics/canary` как два
   разных scrape job в Prometheus (например, `job: five-keys-bot` и
   `job: five-keys-bot-canary`). Это позволит сравнивать P95 латентность и
   error rate между версиями.

## Запуск канарейки

1. Сборка новой версии контейнера и деплой в `five-keys-bot-canary` с
   `CANARY=1`.
2. Убедитесь, что балансировщик перезагружен с конфигурацией из
   [`deploy/nginx.conf`](../deploy/nginx.conf). Канареечный трафик ограничен
   10% и липнет к пользователям благодаря `split_clients`.
3. Выполните тестовый запрос на
   `https://<ваш-домен>/webhook-canary`, чтобы убедиться, что новая версия
   отвечает корректно.
4. Проверьте в Prometheus, что новый scrape job (`five-keys-bot-canary`) видит
   метрики из `/metrics/canary` и содержит лейбл `deployment_variant="canary"`.

## Наблюдение за метриками

* Минимальный период наблюдения: **30 минут** после включения канарейки.
* Ключевые показатели:
  - P95 latency (`histogram_quantile(0.95, rate(<metric>{job="five-keys-bot-canary"}[5m]))`).
  - Error rate (например, `sum(rate(bot_errors_total{job="five-keys-bot-canary"}[5m]))`).
* Сравните значения с продакшен-джобом `five-keys-bot`. Канарейка должна быть не
  хуже по P95 и error rate.

Фиксируйте результаты в журнале релиза или тикете релиза.

## Промоушен

После того как графики зелёные:

1. Запустите скрипт [`tools/canary_promote.sh`](../tools/canary_promote.sh):

   ```bash
   KUBE_NAMESPACE=prod \
   PROD_DEPLOYMENT=five-keys-bot \
   CANARY_DEPLOYMENT=five-keys-bot-canary \
   CONTAINER_NAME=bot \
   ./tools/canary_promote.sh
   ```

   Скрипт вычитает образ из канареечного deployment'а, применяет его к продовому
   и дожидается окончания `kubectl rollout status`. Канареечный deployment будет
   автоматически скейлен в ноль, чтобы весь трафик шёл на новый билд.
2. Подтвердите, что балансировщик обновлён и теперь весь трафик обслуживает
   стабильный deployment (при необходимости перезагрузите nginx).
3. Оставьте систему под наблюдением ещё **15 минут** и зафиксируйте метрики.

## Откат

Если метрики или ручные проверки показали регрессию:

1. Выполните [`tools/canary_rollback.sh`](../tools/canary_rollback.sh) для
   возврата на предыдущую ревизию:

   ```bash
   KUBE_NAMESPACE=prod \
   PROD_DEPLOYMENT=five-keys-bot \
   ./tools/canary_rollback.sh
   ```

   При необходимости можно указать конкретный номер ревизии
   (`--revision 3`). Скрипт скейлит канарейку в ноль, чтобы трафик не
   попадал на проблемный билд.
2. Верните балансировщик к 100% трафика на стабильный backend.
3. Создайте задачу на исправление релизных проблем и запланируйте новую
   канарейку.

## Полезные советы

- Для ручного тестирования на канарейке используйте webhook URL
  `https://<ваш-домен>/webhook-canary`.
- Если требуется увеличить долю канареечного трафика, измените процент в блоке
  `split_clients` файла [`deploy/nginx.conf`](../deploy/nginx.conf) и
  перезагрузите nginx. Не забывайте фиксировать изменения в релизной документации.
- Всегда прогоняйте smoke-тесты после промоушена и отката.
