# Канарейка и безопасные релизы

## Цели

- Проверять новые фичи на ограниченной аудитории.
- Снизить риск массового падения из-за регрессий.

## Подход

1. **Отдельный бот-токен.** Создай канареечного бота у BotFather. Укажи токен в `.env.canary` и используй при запуске второго инстанса (`BOT_TOKEN_CANARY`).
2. **Изолированный webhook.** Настрой отдельный домен/путь (например, `https://canary.example.com/tribute/webhook`). Значения `WEB_PORT` и `TRIBUTE_WEBHOOK_PATH` можно переопределить через переменные окружения.
3. **Аудитория.** В `app/storage.USERS` предусмотрен словарь — добавь флаг `"canary": True` для выбранных пользователей (через скрипт или админ-команду). В хендлерах проверяй флаг перед использованием новых возможностей.
4. **Фича-флаги.** Управляй доступом через переменные из `app/config.py`. Например, введи `NEW_FLOW_ENABLED` и оборачивай код условием.

## Процесс раскатки

1. Создай ветку, задеплой на канареечный инстанс.
2. Прогони smoke-тесты: `/start`, один квиз, webhook Tribute, генерация PDF.
3. Мониторь метрики (ошибки, события) минимум 2 часа.
4. Если всё ок — мержи и выкатывай на production.
5. При проблемах — откати ветку и выключи канареечный инстанс.

## Мониторинг канарейки

- Synthetic `/start` на канареечном токене.
- Сравнение количества ошибок с прод-инстансом.
- Ручная проверка новых сценариев.

## Отключение

- Останови канареечный процесс.
- Сбрось webhook у канареечного бота.
- Удали временные флаги из `.env`.
