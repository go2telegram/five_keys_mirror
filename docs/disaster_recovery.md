# Disaster Recovery Plan

## Цели восстановления

| Объект | RTO | RPO |
|--------|-----|-----|
| Telegram-бот (основной функционал) | 30 минут | 5 минут |
| Tribute webhook | 30 минут | 0 минут (не теряем входящие запросы) |
| История лидов и событий | 4 часа | 24 часа |

## Сценарии и действия

### 1. Полное падение сервера

1. Развёрни резервный инстанс (используй `start_dev.sh` как ориентир для зависимостей).
2. Скопируй `.env` и шрифты (`app/fonts/`).
3. Установи зависимости: `pip install -r requirements.txt`.
4. Запусти `python -m app.main` или сервисный unit.
5. Пропиши новый webhook у Telegram: `curl -X POST https://api.telegram.org/bot<BOT_TOKEN>/setWebhook -d url=https://<host>/<path>`.

### 2. Потеря Tribute webhook

1. Проверь, что порт `settings.WEB_PORT` открыт и процесс слушает.
2. На резервном сервере подними aiohttp (`python -m app.main`).
3. Обнови URL в Tribute dashboard на новый хост.
4. Восстанови секрет `settings.TRIBUTE_API_KEY`.
5. Проверь подпись: сравнивай HMAC как в `app/handlers/tribute_webhook.py`.

### 3. Утечка или отзыв токена бота

1. Сгенерируй новый токен у BotFather.
2. Обнови `.env` (`BOT_TOKEN`) на всех средах.
3. Перезапусти процесс.
4. Сбрось старый webhook и установи новый.

### 4. Потеря данных

Персистентного хранилища нет: `USERS`, `SESSIONS`, `EVENTS`, `LEADS` живут в памяти (`app/storage.py`). Рекомендуется:

1. Делать ежедневный дамп через вспомогательный скрипт (например, `python -m Вспомогательное.get_chat_id` можно использовать как шаблон работы с API). Сохраняй JSON со снэпшотом словарей.
2. Хранить дампы в защищённом бакете (S3/GCS) минимум 7 дней.
3. При восстановлении загружай дамп в память до старта сервиса (добавь временный инициализатор при необходимости).
4. Критичные лиды дублируй в CRM вручную.

## Проверка плана

- Ежеквартально проводи DR-учения: поднимаем новый сервер, настраиваем webhook, выполняем smoke-тесты.
- Документируй отклонения и улучшения.
