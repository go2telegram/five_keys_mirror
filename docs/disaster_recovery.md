# План аварийного восстановления

Этот документ описывает стратегии устойчивости и пошаговые инструкции восстановления
для ключевых компонентов бота: PostgreSQL, Redis и самого приложения.

## Цели и метрики

- **RPO** (допустимая потеря данных): ≤ 15 минут для PostgreSQL, ≤ 5 минут для Redis (кэш).
- **RTO** (время восстановления): ≤ 30 минут для PostgreSQL, ≤ 10 минут для Redis,
  ≤ 20 минут для приложения.
- Все инструкции воспроизводимы и могут быть запущены оператором без глубокого
  знания внутреннего устройства кода.

## Компоненты

| Компонент | Назначение | Развёртывание | Резервирование |
|-----------|------------|---------------|----------------|
| PostgreSQL | постоянное хранилище лидов, статистики и других данных | docker-compose или управляемый сервис | ежедневный `pg_dump`, ежечасный snapshot диска |
| Redis | кэш состояний и сессий, второстепенные данные | docker-compose / отдельный контейнер | без резервного копирования; допускается инвалидация |
| Приложение | Telegram-бот, aiohttp вебхуки | docker-compose сервис `bot` | образ в Registry, конфигурация в .env |

## Резервные копии

### PostgreSQL

1. **Ежедневный дамп**
   ```bash
   export PGPASSWORD="$POSTGRES_PASSWORD"
   pg_dump \
     --format=custom \
     --file="/backups/five_keys_$(date +%Y%m%d_%H%M).dump" \
     --dbname="$POSTGRES_DB" \
     --host="$POSTGRES_HOST" \
     --username="$POSTGRES_USER"
   ```
2. **Инкрементальный snapshot** диска/тома (если используется облачный провайдер).
3. Хранить минимум 7 полных копий + 30 дневных snapshot'ов в отдельном bucket.

### Redis

- Специальные бэкапы не требуются. Достаточно включить AOF снапшот каждые 5 минут.
- При восстановлении допускается потеря данных в пределах RPO.

### Конфигурация

- Репозиторий кода: Git (GitHub/GitLab), хранить копию в отдельном зеркале.
- `.env` файл и секреты: менеджер секретов (1Password/Vault). Экспорт раз в неделю.

## Сценарии аварий

### 1. Полная потеря PostgreSQL

**Симптомы:** ошибки подключения, таймауты при запросах к БД, метрика `bot_db_pool_healthy=0`.

**Действия:**

1. Оценить масштаб проблемы: `docker compose ps postgres` или проверка статуса управляемого сервиса.
2. Если контейнер упал:
   ```bash
   docker compose logs postgres --tail 200
   docker compose up -d postgres
   ```
3. При повреждении данных:
   ```bash
   docker compose stop bot
   docker compose stop postgres
   docker volume rm five_keys_pgdata_corrupted   # переименовать старый том
   docker volume create five_keys_pgdata
   docker compose up -d postgres
   ```
4. Восстановить из последнего дампа:
   ```bash
   export PGPASSWORD="$POSTGRES_PASSWORD"
   pg_restore \
     --clean --if-exists \
     --dbname="$POSTGRES_DB" \
     --host="$POSTGRES_HOST" \
     --username="$POSTGRES_USER" \
     /backups/five_keys_LAST_GOOD.dump
   ```
5. Перезапустить бота: `docker compose up -d bot`.
6. Проверить работоспособность (`/healthz`, тестовое взаимодействие в Telegram).

### 2. Потеря Redis

**Симптомы:** деградация скорости, пропажа кешированных рекомендаций, предупреждения в логах `cache:fallback`.

**Действия:**

1. Проверить состояние: `docker compose ps redis` или `redis-cli ping`.
2. Если контейнер упал:
   ```bash
   docker compose logs redis --tail 200
   docker compose up -d redis
   ```
3. При повреждении данных достаточно очистить том: `docker volume rm five_keys_redisdata` и поднять сервис заново.
4. Приложение автоматически перейдёт на in-memory кэш. После восстановления Redis запустить `POST /admin/cache/warmup` (если доступно) или просто оставить в эксплуатации — данные заполнит трафик пользователей.

### 3. Потеря сервера / региона

1. Создать новый сервер/кластер.
2. Установить Docker, docker compose, зависимости (Python 3.11, system packages).
3. Клонировать репозиторий, подтянуть переменные окружения.
4. Развернуть инфраструктуру:
   ```bash
   docker compose pull
   docker compose up -d
   ```
5. Восстановить БД из бэкапов (см. сценарий 1).
6. Переключить DNS/вебхук на новый хост, убедиться в доступности через `/healthz`.

## Проверка готовности

- **Ежеквартально** запускать хаос-тесты:
  ```bash
  bash tools/chaos/kill_pg.sh
  bash tools/chaos/kill_redis.sh
  bash tools/chaos/lag_network.sh 150
  ```
- Убедиться, что бот продолжает отвечать, а после возврата сервисов (и `restore_network.sh`) статистика и обработка лидов восстановились.
- Проверять, что `init_db_safe` и `init_cache_safe` логируют успешные переподключения.

## Контрольный список после инцидента

1. Убедиться в восстановлении всех сервисов и актуальности данных.
2. Создать постмортем: что произошло, время обнаружения, RPO/RTO фактически.
3. Обновить инструкции, если шаги требовали ручных корректировок.
4. Запланировать дополнительные автоматические проверки, если инцидент выявил новый класс проблем.
