# Операционное досье бота

Документ описывает цели по надежности бота, набор метрик и алертов, а также рабочие процедуры для быстрой диагностики.

## Service Level Objectives (SLO)

| Показатель | Цель | Окно наблюдения | Методика измерения |
|------------|------|-----------------|--------------------|
| Доступность | ≥ 99.9 % | 30 дней | `up{job="five_keys_bot"}` (Prometheus). Берём долю успешных опросов за окно. |
| P95 латентность | ≤ 250 мс | 30 дней | `histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{app="five_keys_bot"}[5m])) by (le))`. |
| Ошибки | ≤ 0.1 % от запросов | 30 дней | `sum(rate(http_requests_total{app="five_keys_bot",status=~"5.."}[5m])) / sum(rate(http_requests_total{app="five_keys_bot"}[5m]))`. |

### Интерпретация целей

- **Доступность** считается по тому, отвечает ли процесс health‑эндпоинту. Если `up` падает до нуля более чем на 0.1 % времени внутри 30‑дневного окна, цель нарушена.
- **P95 латентность** — 95‑й перцентиль времени ответа API. Мы агрегируем гистограмму по экземплярам и следим, чтобы значение не превышало 0.25 секунды.
- **Доля ошибок** — отношение пятисотых к общему количеству запросов.

## Метрики и дашборды

1. **Экспортер**: сам бот публикует `/metrics` с метриками Prometheus. Обязательные метки: `app="five_keys_bot"`, `instance`, `job`.
2. **Основные метрики**:
   - `up{job="five_keys_bot"}` — состояние health‑чека.
   - `http_request_duration_seconds_bucket` — гистограмма длительностей обработчиков.
   - `http_requests_total` — счётчик запросов с метками `status`, `handler`.
3. **Дашборды**:
   - Панель «Availability»: граф `up`, таблица ошибок, графика алертов.
   - Панель «Latency»: перцентильные графики с оверлеем SLO (250 мс) и аннотациями алертов.
   - Панель «Errors»: stacked bar по классам статусов и доля ошибок в процентах.

### Как читать дашборды

- Используйте преднастроенный диапазон 30 дней, чтобы оценить соблюдение SLO.
- Проваливайтесь в 6/1/0.5 часа для расследования инцидентов и корреляции с релизами.
- Для каждого алерта внизу панели доступен runbook со ссылкой на этот документ.

## Алерты

Файл [`ops/alerts.yml`](../ops/alerts.yml) содержит правила для Prometheus/Alertmanager:

| Alert | Условие | Таймаут | Действие |
|-------|---------|---------|----------|
| `BotDown` | `up` == 0 | 2 мин | критический пейдж в Telegram | 
| `HighLatency` | P95 > 250 мс 10 минут подряд | 10 мин | предупреждение в Telegram |
| `ErrorRate` | Ошибки > 0.1 % | 10 мин | предупреждение в Telegram |

Интеграция в Telegram настраивается в Alertmanager (webhook бота или готовый receiver). Укажите контактную группу `telegram-ops`, чтобы алерты из этого файла доходили до онкола.

## Дымовые тесты

Запускайте скрипт `tools/smoke.sh` перед релизами и в CI. Скрипт проверяет `/ping` и `/metrics`, завершаясь сообщением `SMOKE OK`.

Пример локального запуска:

```bash
HEALTH_PORT=8080 python run.py &
SERVER_PID=$!
sleep 2
bash tools/smoke.sh
kill $SERVER_PID
```

Если тест падает, изучите логи процесса и убедитесь, что эндпоинты отвечают с HTTP 200.

## Runbook

1. Получили алерт → откройте соответствующий дашборд.
2. Сверьте текущее значение метрики с SLO.
3. Проверьте логи бота и недавние релизы.
4. При необходимости задействуйте откат и уведомите заинтересованных.

Дополнительно: для отладки проблем задержек снимайте профилирование (`PYTHONASYNCIODEBUG=1`) и проверяйте очереди сообщений в брокере.
