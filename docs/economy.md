# Глобальная внутренняя экономика

## Обзор
Экономический слой токенизирует активность пользователей. Каждый пользователь получает кошелёк, в котором видны баланс, уровень и история операций. Экосистема использует абстрактные «токены» — это внутренняя единица, не криптовалюта.

Ключевые сущности:
- `economy_wallets` — словарь в памяти с полями `user_id`, `balance`, `level`, а также накопленной статистикой `tokens_earned` и `tokens_spent`.
- Леджер транзакций (`economy.service.LEDGER`) для отчётности и контроля.
- Маппинг базовых наград (`app.storage._REWARD_RULES`), который начисляет токены за ключевые события бота:
  - `/start` → +10 (приветственный бонус)
  - завершение квиза (`quiz_finish`) → +25
  - приглашение друга (`ref_join`) → +50

## Команды бота
- `/wallet` — показывает баланс, уровень и последние операции пользователя.
- `/transfer <uid> <amount>` — переводит токены на другой кошелёк (при включённой экономике).

Все операции логируются в `app.storage.save_event`, что позволяет отслеживать вовлечённость.

## Метрики и отчётность
Сервис `economy.service` ведёт агрегаты `tokens_earned` и `tokens_spent`. Ежедневно APScheduler запускает `jobs.economy_report.send_daily_economy_report`, который отправляет админу сводку по обороту и топу кошельков.

## Конфигурация
Фичу можно отключить через переменную окружения `ENABLE_GLOBAL_ECONOMY=false`. В этом случае команды и задания не активируются. Час запуска отчёта настраивается `ECONOMY_REPORT_HOUR_LOCAL` (по умолчанию 21:00 локального времени из `settings.TZ`).

## Тестирование
Для ручной проверки выполните три транзакции (например, начисление, списание и перевод), затем вызовите `/wallet` и убедитесь в корректности баланса и истории. Вызов `economy.service.get_turnover_summary()` покажет агрегированный оборот за день.
