# Каталог: админка и аналитика

Новые возможности каталога доступны, когда `ENABLE_CATALOG_ADMIN=true` (по умолчанию).

## Админ-команды

* `/catalog_reload` — перечитать `products.json`. Используй после обновления ассортимента. В ответ приходит путь к файлу и количество позиций.
* `/catalog_stats` — сводка просмотров и кликов по товарам и категориям за 24 часа и 7 дней. Считаются только реальные выдачи (подборщик, квизы, калькуляторы) и клики по кнопкам «Купить».
* `/catalog_broken` — ручная проверка ссылок (buy/image). Выводит список проблем либо подтверждает, что всё ок.

Команды доступны только администраторам (`ADMIN_ID` + значения из `ADMIN_IDS`).

## Автопроверка ссылок

Каждую ночь (03:30 по `settings.TZ`) запускается `jobs.catalog_checks.run_catalog_link_check`. Отчёт отправляется в чат `CATALOG_ADMIN_CHAT_ID` или, если он не задан, главному администратору (`ADMIN_ID`).

## products.json

Каталог подгружается из `app/products.json`. Формат:

```json
{
  "products": [
    {
      "id": "T8_EXTRA",
      "title": "T8 EXTRA",
      "bullets": ["…", "…"],
      "image_url": "https://…/extra.jpg",
      "buy_url": "https://shop…",
      "categories": ["energy"]
    }
  ]
}
```

Можно добавлять дополнительные поля — они игнорируются. При отсутствии файла используется встроенный fallback.

## UTM-метки

Каждый переход по кнопке «Купить …» в боте оборачивается в callback:

* Если в `buy_url` нет готовых UTM-параметров, добавляются `utm_source=tg_bot`, `utm_medium=catalog`, `utm_campaign=<кампания>`, `utm_content=<product_id>`.
* `<кампания>` берётся из сценария (picker/квизы/калькуляторы) и совпадает с `utm_campaign` в статистике.

## Отключение

Чтобы полностью отключить админ-команды и ночную проверку ссылок, выставь `ENABLE_CATALOG_ADMIN=false`.
