# Meta policy AI

Модуль самоограничения помогает боту вырабатывать и документировать внутренние правила поведения на основе метрик эксплуатации.

## Основные компоненты

- `policy/engine.py` — ядро, которое:
  - хранит последние значения метрик;
  - вычисляет рекомендации и активные правила;
  - фиксирует изменения в `policy/history.jsonl`.
- `bot/admin_policy.py` — админские команды для проверки статуса и ручных симуляций (`/policy_status`, `/policy_history`, `/policy_simulate`).
- HTTP-эндпоинты `GET /policy_status`, `POST /metrics`, `GET /metrics`, `GET /ping`, `GET /version`.

## Пороговые правила

Сейчас контролируются две базовые метрики:

| Метрика | Предупреждение | Предел | Критический уровень | Действие |
| --- | --- | --- | --- | --- |
| `error_rate` | ≥ 8% | ≥ 12% | ≥ 25% | Снижение авторассылки, расследование причин ошибок |
| `response_latency` | ≥ 4s | ≥ 6s | ≥ 8s | Расследование задержек, аудит пайплайна |

При возврате значений ниже `recovery` (5% для ошибок и 3s для задержек) политика автоматически снимается.

## История и аудит

Каждое изменение набора политик записывается отдельной строкой в `policy/history.jsonl`. Запись содержит:

- `ts` — временную метку в формате ISO;
- `metrics` — снимок метрик, спровоцировавших изменение;
- `policies` — список активных правил с приоритетами и статусом;
- `rationales` — текстовые объяснения;
- `source` — происхождение обновления (`system`, `telegram-admin`, `http`).

## Отключение

Для полного отката установите переменную окружения `ENABLE_META_POLICY_AI=false`. При этом команды и эндпоинты продолжат отвечать, но вернут сообщение о том, что модуль выключен, и не будут изменять историю.
