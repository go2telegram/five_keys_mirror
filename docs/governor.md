# Автономное управление (Governor)

Governor выполняет правила из `governor/rules.yml` каждые 5 минут и автоматически применяет действия, если нарушены SLO.

## Как это работает

1. Метрики собираются в `app/metrics.py`. Их можно обновить из любого места бота через `await set_metric("metric", value)`.
2. Планировщик (`APScheduler`) вызывает `governor_tick` раз в 5 минут.
3. `governor/engine.py` читает YAML-DSL правил и выполняет соответствующие действия.
4. Все срабатывания пишутся в `governor.log` и доступны через `/governor_status`.

## DSL правил

```yaml
- if: error_rate > 0.5
  do:
    disable_feature: auto_notify
- if: revenue_drop_percent > 20
  do:
    alert: "Revenue drop"
```

* `if` — простое сравнение `<метрика> <оператор> <значение>`.
* Поддерживаются операторы `>`, `>=`, `<`, `<=`, `==`, `!=`.
* `disable_feature` отключает внутренний флаг фичи (сейчас `auto_notify`).
* `alert` отправляет сообщение админу.

## Команда администратора

В Телеграме: `/governor_status` — показывает текущие правила, активные нарушения и историю последних срабатываний.

## Логи и откат

* Лог: `governor.log`.
* Чтобы откатить изменения — очистите `governor/rules.yml` и перезапустите планировщик (или закомментируйте job в `app/scheduler/service.py`).
