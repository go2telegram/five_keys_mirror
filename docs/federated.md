# Federated learning для five_keys_bot

## Общая идея

Каждый инстанс обучает свою локальную модель и раз в сутки синхронизирует веса с
центральным сервером федеративного обучения. Сервер применяет простую
агрегацию FedAvg и рассылает средние веса обратно всем клиентам. Полученные
агрегированные веса сохраняются в `models/_merged.pkl`.

```
┌───────────┐    POST /sync_model    ┌────────────┐
│  Клиент A │ ─────────────────────▶ │            │
│           │ ◀───────────────────── │            │
└───────────┘      глобальные веса   │  Сервер    │
┌───────────┐                         │ FedAvg     │
│  Клиент B │ ─────────────────────▶ │            │
│           │ ◀───────────────────── │            │
└───────────┘                         └────────────┘
```

## Конфигурация

Переменные окружения/настройки:

- `ENABLE_FED_LEARNING` — включает ежедневную синхронизацию (по умолчанию выключено).
- `FED_SERVER_URL` — базовый URL федеративного сервера. Точка входа `/sync_model` добавляется автоматически.
- `FED_CLIENT_ID` — необязательный идентификатор клиента. Если не задан, используется hostname.
- `FED_LOCAL_MODEL_PATH` — путь до локальных весов, которые будем отправлять (по умолчанию `models/local.pkl`).
- `FED_MERGED_MODEL_PATH` — путь, куда сохраняется агрегированная модель (по умолчанию `models/_merged.pkl`).
- `FED_SYNC_HOUR` / `FED_SYNC_MINUTE` — локальное время запуска синхронизации (по умолчанию 03:00 по `TZ`).

## Клиентская логика

В модуле `ml/federated.py` реализован `FederatedLearningClient` с методом
`sync()`. Он выполняет следующие шаги:

1. Загружает локальные веса из `FED_LOCAL_MODEL_PATH` (если файл отсутствует —
   отправляет пустой словарь).
2. Отправляет POST-запрос на `{FED_SERVER_URL}/sync_model` c JSON:
   ```json
   {
     "client_id": "bot-my-host",
     "weights": {"dense": [0.1, 0.2, ...]},
     "metrics": {"accuracy": 0.82}
   }
   ```
3. Получает от сервера агрегированные веса и метрики и сохраняет их в
   `FED_MERGED_MODEL_PATH`.
4. Возвращает словарь с основными данными синхронизации (путь к файлу,
   локальная и глобальная точность, исходный ответ сервера).

Есть вспомогательные функции `fed_avg()` и `aggregate_client_payloads()` —
ими может пользоваться серверная часть для вычисления средних весов и метрик.

## Планировщик

Файл `jobs/federated_sync.py` содержит задачу `sync_federated_model()`, которая
поднимает клиента и запускает синхронизацию. В `app/scheduler/service.py` эта
задача регистрируется в APScheduler с суточным расписанием.

## Проверка работоспособности

1. Запустите два инстанса бота с разными `FED_CLIENT_ID`, но одним
   `FED_SERVER_URL`.
2. Убедитесь, что оба инстанса выполняют POST `/sync_model` и получают
   агрегированные веса.
3. Проверьте, что после синхронизации в обоих окружениях появился файл
   `models/_merged.pkl` и метрика `accuracy` в логе выросла относительно
   локальной.

## Откат

Чтобы отключить федеративное обучение, выставьте `ENABLE_FED_LEARNING=false`
или удалите `ml/federated.py`, `jobs/federated_sync.py` и связанные настройки
в планировщике.
