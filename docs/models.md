# Ежедневное самообучение моделей

Система ежедневно переобучает три лёгкие модели (recommendations, segments, ctr).
Обучение выполняется в CPU с помощью простого логистического классификатора и
хранится в директории `models/` с версионными файлами `models/<name>_vX.pkl`.

## Контур обучения

1. `jobs/model_retrain.py` запускается по cron (или APScheduler) и по очереди вызывает
   `ml.train_daily.train_model` для каждой модели из реестра.
2. `ml/train_daily.py` забирает данные из Data Lake (локальный CSV в `data_lake/` или
   синтетический датасет), бьёт их на train/test, обучает модель и оценивает точность.
3. Если новая версия даёт точность хуже предыдущей более чем на 5 процентных пунктов,
   происходит откат — новая версия не сохраняется, метрики помечаются как `rolled_back`.
4. При успехе модель сохраняется в `models/<name>_vX.pkl`, метрики обновляются.

## Метрики

* Все метрики лежат в `metrics/models.json`.
* Формат записи:

```json
{
  "recommendations": {
    "model_version": 6,
    "model_accuracy": 0.8734,
    "last_trained": "2024-08-31T00:00:00+00:00",
    "status": "active"
  }
}
```

Эндпоинт `/metrics` отдаёт словарь `{"models": ...}`. Аналогично доступны `/ping` и `/version`.

## Rollback

* Откат автоматический — срабатывает, если drop > 0.05.
* Для полного выключения self-training установите переменную окружения
  `ENABLE_SELF_TRAINING=false` и перезапустите сервис.
* При необходимости ручного отката достаточно удалить артефакты из `models/`
  и восстановить нужную версию.

## Ручной запуск

```bash
python ml/train_daily.py --model=recommendations
python ml/eval.py --compare models/recommendations_v5.pkl models/recommendations_v6.pkl
```

Команда `ml/eval.py` сравнивает точность двух артефактов на актуальном тестовом сете.
