# Руководство по выпуску релизов

Этот документ описывает единый процесс подготовки и выкладки релизов Five Keys Bot. Следуйте шагам ниже, чтобы каждая команда знала, что проверять, а результат релиза появлялся в GitHub Release вместе с self-audit summary.

## Подготовка

1. Проверьте, что основная ветка `main` зелёная и содержит все необходимые изменения.
2. Убедитесь, что changelog и документация обновлены, а миграции успешно проходят локально (`alembic upgrade head`).
3. Согласуйте целевое окно релиза со службой поддержки и маркетингом.
4. Соберите артефакты: актуальный `products.json`, статические файлы и дамп базы для восстановления.

## Как поставить тег

1. Перейдите в актуальную ветку релиза (обычно `main`).
2. Обновите локальный репозиторий: `git pull --rebase origin main`.
3. Сформируйте версию в формате `vYYYY.MM.DD-x` или семантическую `vX.Y.Z` (по договорённости).
4. Создайте аннотированный тег:
   ```bash
   git tag -a vX.Y.Z -m "Release vX.Y.Z"
   git push origin vX.Y.Z
   ```
5. Запустите GitHub Actions workflow «Release» вручную, выбрав созданный тег. Workflow приложит self-audit summary к `RELEASE_NOTES.md` и создаст GitHub Release.

## Как проверить STAGE

1. Дождитесь деплоя тега в staging (workflow «Deploy Stage»). В `.env` на STAGE задайте стандартные переменные (`MEDIA_REF`, `IMAGES_BASE`, `QUIZ_IMG_BASE`, `SENTRY_DSN`, `SENTRY_TRACES_SAMPLE_RATE`) значениями из матрицы окружений для STAGE. Префиксы `STAGE_*` используются только как подсказка в матрице, сами переменные остаются без префикса.
2. Проверьте доступность webhook-эндпоинта и дашборда:
   - `GET /health` возвращает `200`.
   - `GET /admin/dashboard?token=<STAGE_TOKEN>` открывается и отображает актуальные графики.
3. Выполните ручные сценарии:
   - Квиз: пройдите `/quiz`, убедитесь, что рекомендации выдаются и картинки подгружаются со staging-медиарепозитория.
   - Premium-центр: `/premium_center`, проверка планов и прогресса.
   - Проверка новых фич согласно релиз-заметкам.
4. Убедитесь, что в Sentry (проект STAGE) нет новых ошибок за последние 30 минут. Отфильтруйте по релизу `vX.Y.Z+stage`.
5. Заполните раздел self-audit в `RELEASE_NOTES.md` (чек-лист STAGE) и подтвердите, что тесты пройдены.

## Как проверить PROD

1. После завершения staging-а согласуйте окно выкладки и запустите workflow «Deploy Prod» для того же тега.
2. Проверьте, что продовый `.env` содержит стандартные переменные (`MEDIA_REF`, `IMAGES_BASE`, `QUIZ_IMG_BASE`, `SENTRY_DSN`, `SENTRY_TRACES_SAMPLE_RATE`) со значениями из блока PROD матрицы окружений. Аналогично, `PROD_*` служит подсказкой — в файле остаются имена без префикса.
3. Мониторинг после деплоя:
   - Telegram-команды `/start`, `/premium_center`, `/catalog_report`.
   - Проверка вебхука: `GET /health` (через публичный URL или туннель).
   - Дашборд `/admin/dashboard?token=<PROD_TOKEN>`: убедитесь, что графики обновляются, CTR не обнулился, заявки и планы отображаются.
4. Проверьте Sentry (проект PROD) по релизу `vX.Y.Z`. Новые ошибки должны быть либо подтверждены, либо заведены в backlog.
5. Обновите self-audit: отметьте выполненные проверки PROD, добавьте ссылки на Sentry и дашборд.

## Как откатиться

1. Оцените масштаб проблемы: новые ошибки в Sentry, жалобы пользователей, падение webhook.
2. Если требуется откат, запустите workflow «Deploy Prod» со старым стабильным тегом (например, `vX.Y.Z-1`).
3. Убедитесь, что GitHub Release обновлён (при необходимости добавьте комментарий о временном откате).
4. Сообщите командам (поддержка, маркетинг) о завершении отката и ожидаемых последствиях.
5. Завершите инцидент постмортемом: добавьте в backlog задачи на исправление и обновите runbook, если нашли пробелы.

## Как читать /admin/dashboard

1. Авторизуйтесь токеном (`Authorization: Bearer <TOKEN>` или параметр `?token=`).
2. Основные блоки:
   - **Quiz events** — распределение по последним квизам; помогает оценить стабильность воронки.
   - **Calculator usage** — топ использований калькулятора по событиям.
   - **Quiz → Recommendation CTR** — оперативный CTR; если падает ниже нормы, проверьте цепочку выдачи рекомендаций.
   - **Топ продуктов и цели каталога** — убедитесь, что сборка каталога корректна (ожидаемые 38/38).
   - **Последние заявки** — таблица заявок с деталями квиза и планов.
3. При аномалиях экспортируйте HTML через «Сохранить как…» и приложите к отчёту в self-audit.

## Как читать Sentry

1. Разделите проекты по окружениям: `five-keys-stage` и `five-keys-prod` (настроить заранее).
2. Используйте фильтры по релизу (`Release: vX.Y.Z`) и окружению (`Environment: stage/prod`).
3. Для каждой новой ошибки:
   - Проверьте частоту и уникальность (Group by Issue).
   - Назначьте ответственного и добавьте ссылку на задачу в tracker.
   - Если ошибка критична, инициируйте откат.
4. После релиза убедитесь, что уровень ошибок соответствует базовой линии. Обновите self-audit ссылкой на дашборд Sentry и статусом (ok/warn).

## Self-audit и итог релиза

1. Заполните чек-лист в `RELEASE_NOTES.md` перед запуском workflow и обновите после завершения PROD-проверок.
2. Убедитесь, что GitHub Release содержит:
   - Summary изменений.
   - Self-audit summary с отметками STAGE/PROD.
   - Ссылки на дашборд и Sentry при необходимости.
3. Расшарьте ссылку на релиз в командном чате.
