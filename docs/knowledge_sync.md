# Глобальная синхронизация знаний

Модуль синхронизации знаний позволяет обмениваться векторными индексами между несколькими
кластерами Five Keys. Каждый узел хранит локальный репозиторий embeddings и публикует HTTP API
`/knowledge_sync`, через которое кластеры обмениваются изменениями.

## Архитектура

- `knowledge/sync.py` — сервис синхронизации и обработчик API.
- `jobs/knowledge_sync.py` — асинхронная джоба, которую вызывает APScheduler.
- HTTP API `/knowledge_sync` принимает действия `pull` и `push`.

Сервис поддерживает md5-проверку для консистентности индексов и не позволяет выходить за границы
каталога с данными.

## API

### POST /knowledge_sync {"action": "pull"}

Поле `known` — список индексов, уже имеющихся локально, в формате:

```json
{"path": "catalog/faiss.index", "md5": "..."}
```

Ответ содержит изменённые индексы (`indexes`), удалённые (`removed`) и полный инвентарь (`inventory`).
Контент индекса кодируется в base64.

### POST /knowledge_sync {"action": "push"}

Запрос включает `indexes` (массив индексов с контентом) и `removed` (пути для удаления). Сервер
перепроверяет md5 перед записью и возвращает статистику применения и обновлённый инвентарь.

## Планировщик

При установке `ENABLE_GLOBAL_KNOWLEDGE_SYNC=true` APScheduler добавляет периодическую задачу, которая:

1. Выполняет `pull` у каждого пира и применяет изменения локально.
2. Сравнивает md5 и отправляет отсутствующие индексы обратно (`push`).
3. Контролирует дрейф: несовпадение больше 1% логируется предупреждением.

Интервал задаётся переменной `GLOBAL_KNOWLEDGE_SYNC_INTERVAL_MINUTES` (по умолчанию 5 минут).

## Конфигурация

| Переменная | Назначение | Значение по умолчанию |
| --- | --- | --- |
| `ENABLE_GLOBAL_KNOWLEDGE_SYNC` | Включает фичу | `false` |
| `KNOWLEDGE_INDEX_DIR` | Каталог с локальными индексами | `storage/knowledge` |
| `GLOBAL_KNOWLEDGE_SYNC_PEERS` | Список пиров (через запятую) | пусто |
| `GLOBAL_KNOWLEDGE_SYNC_TIMEOUT` | Таймаут HTTP-запросов | `30` секунд |
| `GLOBAL_KNOWLEDGE_SYNC_INTERVAL_MINUTES` | Периодичность джобы | `5` минут |

## Rollback

Установите `ENABLE_GLOBAL_KNOWLEDGE_SYNC=false`, перезапустите сервис, и планировщик/маршруты будут
отключены. Модуль можно удалить без влияния на остальные части системы.
