# Security autonomy

Система безопасности бота отслеживает сетевую активность и ключевые логи, чтобы
раньше обнаруживать подозрительные действия.

## Архитектура

- `security/monitor.py` — легковесный IDS-модуль. Реализует middleware для
  aiohttp, анализирует журналы запросов, пытается выявить всплески активности,
  попытки обхода маршрутов и сигнатуры базовых атак. Последние события и
  агрегированная статистика доступны через `/security_status`.
- `bot/admin_security.py` — команды администратора Telegram для просмотра
  состояния безопасности прямо в чате (`/security_status`, `/security_recent`).

## Поведение

- Каждый HTTP-запрос проходит через middleware. Сборщик фиксирует IP, путь,
  User-Agent и код ответа. При обнаружении признаков попытки взлома или
  аномалии создаётся событие с типом `intrusion_attempt`, `suspicious_traffic`
  или `anomaly`.
- `/security_status` (GET) возвращает JSON:
  ```json
  {
    "enabled": true,
    "total_requests": 42,
    "unique_sources": 3,
    "event_counters": {"anomaly": 1},
    "recent_events": [ ... ]
  }
  ```
- При большом количестве запросов с одного IP, несанкционированных маршрутах
  или сигнатурах SQL/XSS атак фиксируется событие `intrusion_attempt` или
  `suspicious_traffic`.
- Медленные ответы и ошибки 5xx отмечаются как `anomaly`.

## Администрирование

- Включение/отключение: переменная окружения `ENABLE_SECURITY_AUTONOMY` (по
  умолчанию `True`). При `False` middleware не активируется, остаётся только
  эндпоинт `/security_status`.
- Просмотр статистики: команда `/security_status` в чате администратора или
  HTTP-запрос на `/security_status`.
- Последние события: команда `/security_recent`.

## Тестирование

1. Отправьте HTTP-запрос на несуществующий путь → в `/security_status` появится
   `intrusion_attempt`.
2. Попросите бота `/security_status` — должно отобразиться количество запросов
   и последние события.

## Rollback

- Установите `ENABLE_SECURITY_AUTONOMY=false` и перезапустите приложение —
  middleware отключится, монитор перестанет фиксировать трафик.
- При необходимости удалите пакет `security` и команды администратора.
