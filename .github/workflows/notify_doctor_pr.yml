name: notify_doctor_pr

on:
  pull_request:
    types: [opened, reopened, labeled]

jobs:
  notify:
    if: contains(github.event.pull_request.labels.*.name, 'needs-human')
    runs-on: ubuntu-latest
    steps:
      - name: Bootstrap env
        run: ./.github/scripts/bootstrap-env.sh
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CODEX_SHARED_KEY: ${{ secrets.CODEX_SHARED_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          IMAGES_BASE: ${{ vars.IMAGES_BASE }}
          QUIZ_IMG_BASE: ${{ vars.QUIZ_IMG_BASE }}
          HEALTH_PORT: ${{ vars.HEALTH_PORT }}
      - name: Send Telegram message
        if: env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
        run: |
          TEXT="🚑 doctor: найдены проблемы\nPR: ${{ github.event.pull_request.html_url }}\nАвтор: ${{ github.event.pull_request.user.login }}\nБранч: ${{ github.event.pull_request.head.ref }}"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${TEXT}" >/dev/null

      - name: Send Slack message
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          jq -nc --arg text "🚑 doctor: найдены проблемы\nPR: ${{ github.event.pull_request.html_url }}\nАвтор: ${{ github.event.pull_request.user.login }}\nБранч: ${{ github.event.pull_request.head.ref }}" \
            '{text: $text}' \
          | curl -s -X POST -H 'Content-type: application/json' --data @- "${SLACK_WEBHOOK_URL}" >/dev/null
